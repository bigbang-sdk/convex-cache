# convex-cache

A library for caching Convex queries on the client and server, providing improved performance and offline capabilities for your Convex-powered applications.

## Features

- üöÄ **Client-side caching** - Cache query results in the browser using local storage
- ‚ö° **Server-side caching** - Preload and cache queries in Next.js server components
- üîÑ **Automatic revalidation** - Smart cache invalidation and revalidation strategies
- üìÑ **Paginated query support** - Built-in support for paginated queries
- ‚úÖ **Type-safe** - Full TypeScript support with Zod schema validation
- üõ†Ô∏è **CLI tool** - Development tooling for generating Zod schemas from Convex functions
- ‚öõÔ∏è **React & Next.js adapters** - Easy integration with React and Next.js applications

## Installation

```bash
npm install convex-cache
# or
bun add convex-cache
# or
yarn add convex-cache
```

## Peer Dependencies

- `next`: ^16.0.4
- `react`: ^19
- `convex`: ^1.29.3

## Quick Start

### 1. Server Cache

Server-side caching requires no setup. Simply use `preloadQuery` to preload your queries and `useCachedQueryServer` to access them:

```typescript
import { preloadQuery } from "convex-cache/next/server";
import { useCachedQueryServer } from "convex-cache/next";
import { api } from "./convex/_generated/api";

export default async function UserPage({ params }) {
  const preloadedData = await preloadQuery({
    query: api.queries.getUser,
    args: { userId: params.userId },
  });

  return <UserProfile preloadedData={preloadedData} />;
}

function UserProfile({ preloadedData }) {
  const user = useCachedQueryServer({
    query: api.queries.getUser,
    args: { userId: params.userId },
    preloadedData,
  });

  return <div>{user.name}</div>;
}
```

### 2. Client Cache

#### Step 1: Setup Convex Queries with Schema Support

Use `vQuery` or `zQuery` to create queries that include Zod schemas for caching:

```typescript
import { vQuery } from "convex-cache/convex";
import { v } from "convex/values";

export const getUser = vQuery({
  args: { userId: v.id("users") },
  returns: v.object({
    id: v.id("users"),
    name: v.string(),
    email: v.string(),
  }),
  handler: async (ctx, args) => {
    return await ctx.db.get(args.userId);
  },
});
```

Or with Zod:

```typescript
import { zQuery } from "convex-cache/convex";
import { z } from "zod";

export const getUser = zQuery({
  args: { userId: z.string() },
  returns: z.object({
    id: z.string(),
    name: z.string(),
    email: z.string(),
  }),
  handler: async (ctx, args) => {
    return await ctx.db.get(args.userId);
  },
});
```

#### Step 2: Generate Schema Map

Use the CLI tool to generate a schema map from your Convex functions:

```bash
convex-cache dev
```

This watches your Convex directory and automatically generates Zod schemas when functions change.

#### Step 3: Setup React Provider

Wrap your app with `ConvexCacheProvider`:

```typescript
import { ConvexProvider, ConvexReactClient } from "convex/react";
import { ConvexCacheProvider } from "convex-cache/react";
import { schemaMap } from "./convex/_generated/schema-map"; // Generated by CLI

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export function App({ children }) {
  return (
    <ConvexProvider client={convex}>
      <ConvexCacheProvider schemaMap={schemaMap}>
        {children}
      </ConvexCacheProvider>
    </ConvexProvider>
  );
}
```

#### Step 4: Use Cached Queries in React

```typescript
import { useCachedQueryClient } from "convex-cache/react";
import { api } from "./convex/_generated/api";

function UserProfile({ userId }) {
  const user = useCachedQueryClient({
    query: api.queries.getUser,
    args: { userId },
  });

  if (!user) return <div>Loading...</div>;

  return <div>{user.name}</div>;
}
```

## API Reference

### React Adapter (`convex-cache/react`)

#### `ConvexCacheProvider`

Provider component that wraps your app and provides schema map context.

**Props:**

- `schemaMap`: `ZSchemaMap` - Schema map generated by the CLI
- `useLocalDb?`: Custom local database hook (optional)

#### `useCachedQueryClient`

Hook for using cached queries in React client components.

```typescript
const result = useCachedQueryClient({
  query: api.queries.myQuery,
  args: {
    /* query args */
  },
});
```

#### `useCachedPaginatedQueryClient`

Hook for using cached paginated queries in React client components.

```typescript
const result = useCachedPaginatedQueryClient({
  query: api.queries.myPaginatedQuery,
  args: {
    /* query args */
  },
  options: {
    /* pagination options */
  },
});
```

### Next.js Adapter (`convex-cache/next`)

#### `useCachedQueryServer`

Hook for using cached queries in Next.js server components.

```typescript
const result = useCachedQueryServer({
  query: api.queries.myQuery,
  args: {
    /* query args */
  },
  preloadedData: preloadedData,
});
```

#### `useCachedPaginatedQueryServer`

Hook for using cached paginated queries in Next.js server components.

```typescript
const result = useCachedPaginatedQueryServer({
  query: api.queries.myPaginatedQuery,
  args: {
    /* query args */
  },
  options: {
    /* pagination options */
  },
  preloadedData: preloadedData,
});
```

### Next.js Server (`convex-cache/next/server`)

#### `preloadQuery`

Preload a query on the server for use in server components.

```typescript
const preloadedData = await preloadQuery({
  query: api.queries.myQuery,
  args: {
    /* query args */
  },
});
```

### Convex Helpers (`convex-cache/convex`)

#### `vQuery`

Wrapper for Convex queries that extracts Zod schemas from Convex validators.

```typescript
import { vQuery } from "convex-cache/convex";
import { v } from "convex/values";

export const myQuery = vQuery({
  args: { id: v.id("users") },
  returns: v.object({ name: v.string() }),
  handler: async (ctx, args) => {
    /* ... */
  },
});
```

#### `zQuery`

Wrapper for Convex queries that uses Zod schemas directly.

```typescript
import { zQuery } from "convex-cache/convex";
import { z } from "zod";

export const myQuery = zQuery({
  args: { id: z.string() },
  returns: z.object({ name: z.string() }),
  handler: async (ctx, args) => {
    /* ... */
  },
});
```

### CLI (`convex-cache`)

#### `convex-cache dev`

Runs Convex dev mode and generates Zod schemas automatically.

```bash
convex-cache dev [options]

Options:
  -d, --dir <convexDir>  Path to the convex directory (default: "convex")
```

## How It Works

1. **Schema Generation**: The CLI tool scans your Convex functions and generates Zod schemas based on the `returns` definitions in your queries.

2. **Client Caching**: Query results are cached in local storage (via `@bigbang-sdk/local-db`) and validated against Zod schemas before being returned.

3. **Server Caching**: In Next.js, queries can be preloaded on the server and cached, reducing client-side requests.

4. **Automatic Revalidation**: The cache is automatically invalidated when new data is fetched from Convex.

## License

MIT

## Author

Bigbang

## Repository

[https://github.com/bigbang-sdk/convex-cache](https://github.com/bigbang-sdk/convex-cache)
